<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì„¤ë¬¸ ì¡°ì‚¬ ë° ê²°ê³¼ ë¶„ì„</title>

<style>
body {
  font-family: "Noto Sans KR", Arial, sans-serif;
  background: #f2f4f8;
  padding: 40px;
}

h1 {
  text-align: center;
  margin-bottom: 30px;
}

#content {
  max-width: 720px;
  margin: auto;
}

.center {
  text-align: center;
}

.card {
  background: #ffffff;
  padding: 30px;
  border-radius: 14px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
}

.progress {
  height: 8px;
  background: #e0e0e0;
  border-radius: 4px;
  margin-bottom: 25px;
  overflow: hidden;
}

.progress-bar {
  height: 100%;
  background: #4a90e2;
  width: 0%;
  transition: width 0.3s;
}

h2 {
  margin-bottom: 20px;
}

label {
  display: block;
  padding: 12px 16px;
  margin-bottom: 10px;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.2s;
  word-break: keep-all;
  white-space: normal;
}

label:hover {
  background: #f0f6ff;
}

input[type="radio"] {
  margin-right: 8px;
}

button {
  margin-top: 20px;
  padding: 10px 22px;
  border: none;
  border-radius: 8px;
  background: #4a90e2;
  color: white;
  font-size: 15px;
  cursor: pointer;
}

button:hover {
  background: #357abd;
}

.result {
  background: #ffffff;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.06);
}

.result h3 {
  margin-bottom: 6px;
}
</style>
</head>

<body>

<h1 id="title">ì„¤ë¬¸ ì¡°ì‚¬</h1>

<div id="content" class="center card">
  <p>ì„¤ë¬¸ CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</p>
  <input type="file" id="csvFile" accept=".csv"><br><br>
  <button onclick="loadCSV()">ì„¤ë¬¸ ì‹œì‘</button>
</div>

<script>
let headers = [];
let data = [];
let current = 0;
let userAnswers = [];

/* ë”°ì˜´í‘œ ê³ ë ¤ CSV íŒŒì‹± */
function parseCSVLine(line) {
  const result = [];
  let value = "";
  let inQuotes = false;

  for (let c of line) {
    if (c === '"') {
      inQuotes = !inQuotes;
    } else if (c === "," && !inQuotes) {
      result.push(value);
      value = "";
    } else {
      value += c;
    }
  }
  result.push(value);
  return result;
}

// CSV ì—…ë¡œë“œ
function loadCSV() {
  const file = document.getElementById("csvFile").files[0];
  if (!file) {
    alert("CSV íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
    return;
  }

  const reader = new FileReader();
  reader.onload = e => {
    const rows = e.target.result
      .trim()
      .split("\n")
      .map(line => parseCSVLine(line));

    headers = rows[0].slice(1).map(h => h.trim());
    data = rows.slice(1).map(r => r.slice(1).map(v => v.trim()));

    startSurvey();
  };

  reader.readAsText(file, "EUC-KR");
}

// ì„¤ë¬¸ ì‹œì‘
function startSurvey() {
  current = 0;
  userAnswers = [];
  showQuestion();
}

// ì§ˆë¬¸ í™”ë©´
function showQuestion() {
  const div = document.getElementById("content");
  div.className = "card";
  div.innerHTML = `
    <div class="progress">
      <div class="progress-bar" id="bar"></div>
    </div>
  `;

  document.getElementById("bar").style.width =
    ((current) / headers.length * 100) + "%";

  const q = headers[current];

  const options = [...new Set(
    data.map(r => r[current]).filter(v => v)
  )];

  div.innerHTML += `<h2>${current + 1}. ${q}</h2>`;

  options.forEach(opt => {
    div.innerHTML += `
      <label>
        <input type="radio" name="answer" value="${opt}">
        ${opt}
      </label>
    `;
  });

  div.innerHTML += `<button onclick="next()">ë‹¤ìŒ</button>`;
}

// ë‹¤ìŒ ì§ˆë¬¸
function next() {
  const checked = document.querySelector("input[name='answer']:checked");
  if (!checked) {
    alert("ì„ íƒì§€ë¥¼ í•˜ë‚˜ ì„ íƒí•˜ì„¸ìš”.");
    return;
  }

  userAnswers.push(checked.value);
  current++;

  if (current < headers.length) {
    showQuestion();
  } else {
    showResult();
  }
}

// ê²°ê³¼ í™”ë©´
function showResult() {
  document.getElementById("title").innerText = "ì„¤ë¬¸ ê²°ê³¼ ë¶„ì„";
  const div = document.getElementById("content");
  div.className = "";
  div.innerHTML = "";

  /* ë¬¸í•­ë³„ ê²°ê³¼ */
  userAnswers.forEach((ans, i) => {
    const answers = data.map(r => r[i]);
    const same = answers.filter(a => a === ans).length;
    const ratio = ((same / answers.length) * 100).toFixed(1);

    div.innerHTML += `
      <div class="result">
        <h3>${headers[i]}</h3>
        <p>ë‚´ ì„ íƒ: <b>${ans}</b></p>
        <p>ë‚˜ì™€ ê°™ì€ ì„ íƒì„ í•œ ì‚¬ëŒì˜ ë¹„ìœ¨: ${ratio}%</p>
      </div>
    `;
  });

  /* ===== ì¢…í•© ìƒìœ„ % ê³„ì‚° ===== */
  // ê¸°ì¡´ ì‘ë‹µì ê°ê°ì´ ë‚˜ì™€ ëª‡ ë¬¸í•­ì´ ê°™ì€ì§€ ê³„ì‚°
/* ===== ì¢…í•© ìƒìœ„ % ê³„ì‚° (ìµœì¢… ìˆ˜ì •ë³¸) ===== */

// ê¸°ì¡´ ì‘ë‹µì ê°ê°ê³¼ 'ë‚˜'ì˜ ìœ ì‚¬ë„ ì ìˆ˜
const similarityScores = data.map(row => {
  let score = 0;
  row.forEach((answer, i) => {
    if (answer === userAnswers[i]) score++;
  });
  return score;
});

// ë‚˜ì˜ ìœ ì‚¬ë„ ì ìˆ˜: ê¸°ì¡´ ì‘ë‹µìë“¤ê³¼ì˜ í‰ê·  ìœ ì‚¬ë„
const myScore =
  similarityScores.reduce((a, b) => a + b, 0) / similarityScores.length;

// ë‚˜ë³´ë‹¤ ìœ ì‚¬ë„ê°€ ë‚®ì€ ì‚¬ëŒ ë¹„ìœ¨
const lowerCount = similarityScores.filter(s => s < myScore).length;

// ìƒìœ„ í¼ì„¼íŠ¸
const percentile = (
  (lowerCount / similarityScores.length) * 100
).toFixed(1);

  div.innerHTML += `
    <div class="result">
      <h2>ğŸ“Š ì¢…í•© ë¶„ì„ ê²°ê³¼</h2>
      <p>
        ì „ì²´ ì‘ë‹µìì™€ ë¹„êµí–ˆì„ ë•Œ,<br>
        ë‚˜ì˜ ì‘ë‹µ íŒ¨í„´ì€ <b>ìƒìœ„ ${percentile}%</b>ì— í•´ë‹¹í•©ë‹ˆë‹¤.
      </p>
    </div>
  `;

  div.innerHTML += `
    <div class="center">
      <button onclick="location.reload()">ì²˜ìŒìœ¼ë¡œ</button>
    </div>
  `;
}
</script>

</body>
</html>
